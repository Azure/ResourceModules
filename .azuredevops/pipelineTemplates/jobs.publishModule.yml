#########################################################
## PUBLISH PIPELINE                                    ##
#########################################################
##
## This pipeline template contains the logic to publish module data as
## - A build artifact and/or
## - As a new version to a given storage account and/or
## - As a new version as an UniversalPackage to a given artifact-feed
##
#########################################################

##---------------------------------------------##
## TEMPLATE PARAMETERS                         ##
##---------------------------------------------##
##
## By default it uses the variables specified in the below [parameters] section. However, you can overwrite these variables in the
##    referencing pipeline by providing the parameter explicitly.
##
## NOTE: If you don't need to overwrite a shared value, you can IGNORE this section
##
##   |======================================================================================================================================================================================================================|
##   | Parameter                       | Default Value                        | Description                                                                                             | Example                           |
##   |---------------------------------|--------------------------------------|---------------------------------------------------------------------------------------------------------|-----------------------------------|
##   | displayName                     | 'Publishing'                         | Name for the pipeline job                                                                               | 'Publish KeyVault'                |
##   | serviceConnection               | '$(serviceConnection)'               | The service connection that connects to Azure                                                           | 'demo-internal'                   |
##   | poolName                        | '$(poolName)'                        | You can provide either a [poolname] or [vmImage] to run the job on                                      | 'Custom Deployment Pool'          |
##   | vmImage                         | '$(vmImage)'                         | You can provide either a [poolname] or [vmImage] to run the job on                                      | 'ubuntu20.04'                     |
##   | defaultJobTimeoutInMinutes      | 120                                  | The timeout for the job in this pipeline                                                                | 120                               |
##   | modulePath                      | '$(modulePath)'                      | The path to the module to deploy. E.g. [c:/KeyVault]                                                    | 'c:/KeyVault'                     |
##   | publishLatest                   | '$(publishLatest)'                   | Flag to indicate whether or not to publish a "latest" version to Bicep Registry and Template Specs      | true                              |
##   | useApiSpecsAlignedName          | '$(useApiSpecsAlignedName)'          | Flag to indicate whether or not to publish module using their REST API, or their folder path name       | true                              |
##   | templateSpecsRGName             | '$(templateSpecsRGName)'             | Required to publish to template spec. ResourceGroup of the template spec to publish to                  | 'mgmt-rg'                         |
##   | templateSpecsRGLocation         | '$(templateSpecsRGLocation)'         | Required to publish to template spec. Location of the template spec resource group                      | 'West Europe'                     |
##   | templateSpecsDescription        | '$(templateSpecsDescription)'        | Required to publish to template spec. Description of the template spec to publish to                    | 'IaCs module'                     |
##   | vstsFeedToken                   | '$(vstsFeedToken)'                   | Required to publish to a DevOps feed. Token with access to the feed to publish to.                      | '...'                             |
##   | vstsFeedName                    | '$(vstsFeedName)'                    | Required to publish to a DevOps feed. Name to the feed to publish to.                                   | 'modules'                         |
##   | vstsFeedProject                 | '$(vstsFeedProject)'                 | Required to publish to a DevOps feed. Name of the project hosting the artifacts feed. May be empty.     | 'iacs'                            |
##   | bicepRegistryName               | '$(bicepRegistryName)'               | Required to publish to the private bicep registry. Name of the hosting container registry               | 'adpsxxazacrx001'                 |
##   | bicepRegistryRGName             | '$(bicepRegistryRGName)'             | Required to publish to the private bicep registry. Resource group of the hosting container registry     | 'artifacts-rg'                    |
##   | bicepRegistryRgLocation         | '$(bicepRegistryRgLocation)'         | Required to publish to the private bicep registry. Location of the RG of the hosting container registry | 'West Europe'                     |
##   | vstsOrganizationUri             | '$(vstsOrganizationUri)'             | Required to publish to a DevOps feed. Name of the organization hosting the artifacts feed.              | 'servicescode'                    |
##   | azurePowerShellVersion          | '$(azurePowerShellVersion)'          | Used for configuring the Azure PowerShell Version, one of the example values.                           | 'latestVersion' or 'OtherVersion' |
##   | preferredAzurePowerShellVersion | '$(preferredAzurePowerShellVersion)' | Used for configuring the Azure PowerShell Version, either an empty string or specific version.          | '4.4.0'                           |
##   |======================================================================================================================================================================================================================|
##
##---------------------------------------------##

parameters:
  # Pipeline-related parameters
  displayName: 'Publishing'
  serviceConnection: '$(serviceConnection)'
  poolName: '$(poolName)'
  vmImage: '$(vmImage)'
  defaultJobTimeoutInMinutes: 120
  modulesRepository: '$(modulesRepository)'
  subscriptionId: '$(ARM_SUBSCRIPTION_ID)'

  # Logic-related parameters
  ## Module-related
  modulePath: '$(modulePath)'

  # Shared
  publishLatest: '$(publishLatest)'
  useApiSpecsAlignedName: '$(useApiSpecsAlignedName)'

  ## TemplateSpec-related
  templateSpecsDoPublish: '$(templateSpecsDoPublish)'
  templateSpecsRGName: '$(templateSpecsRGName)'
  templateSpecsRGLocation: '$(templateSpecsRGLocation)'
  templateSpecsDescription: '$(templateSpecsDescription)'

  ## Artifact-Feed-related
  artifactsFeedDoPublish: '$(artifactsFeedDoPublish)'
  vstsOrganizationUri: '$(vstsOrganizationUri)'
  vstsFeedProject: '$(vstsFeedProject)'
  vstsFeedName: '$(vstsFeedName)'
  vstsFeedToken: '$(vstsFeedToken)'

  ## Private-Bicep-Registry-related
  bicepRegistryDoPublish: '$(bicepRegistryDoPublish)'
  bicepRegistryName: '$(bicepRegistryName)'
  bicepRegistryRGName: '$(bicepRegistryRGName)'
  bicepRegistryRgLocation: '$(bicepRegistryRgLocation)'

##---------------------------------------------##
## TEMPLATE LOGIC                              ##
##---------------------------------------------##
jobs:
  - job:
    displayName: ${{ parameters.displayName }}
    timeoutInMinutes: ${{ parameters.defaultJobTimeoutInMinutes }}
    pool:
      ${{ if ne(parameters.vmImage, '') }}:
        vmImage: ${{ parameters.vmImage }}
      ${{ if ne(parameters.poolName, '') }}:
        name: ${{ parameters.poolName }}
    steps:
      # [Checkout Repositories] task(s)
      #--------------------------------
      - checkout: self
        fetchDepth: 0

      # [Agent] Prepare environment
      #----------------------------
      - task: PowerShell@2
        displayName: 'Setup agent'
        inputs:
          targetType: inline
          pwsh: true
          script: |
            # Load used functions
            . (Join-Path '$(System.DefaultWorkingDirectory)' 'utilities' 'pipelines' 'sharedScripts' 'Set-EnvironmentOnAgent.ps1')

            # Define PS modules to install on the runner
            $modules = @(
                @{ Name = 'Az.Accounts' },
                @{ Name = 'Az.ContainerRegistry' },
                @{ Name = 'Az.Resources' }
            )

            # Set agent up
            Set-EnvironmentOnAgent -PSModules $modules

      # [Universal Artifact-feed publish] task(s)
      #------------------------------------------
      - task: PowerShell@2
        displayName: 'Publish module to artifacts feed'
        condition: and(
          eq(variables['artifactsFeedDoPublish'], true),
          succeeded()
          )
        enabled: true
        inputs:
          targetType: inline
          pwsh: true
          script: |
            # Load used functions
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesToPublish.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Publish-ModuleToUniversalArtifactsFeed.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesMissingFromUniversalArtifactsFeed.ps1')

            #Prioritizing the bicep file
            $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.bicep'
            if (-not (Test-Path $TemplateFilePath)) {
              $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.json'
            }

            ################################
            ##   Get modules to publish   ##
            ################################
            $functionInput = @{
              TemplateFilePath = $TemplateFilePath
              PublishLatest    = $false # Not supported by Azure DevOps feeds
            }

            Write-Verbose "Invoke Get-ModulesToPublish with" -Verbose
            Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

            $modulesToPublish = @()

            # Get the modified child resources
            $modulesToPublish += Get-ModulesToPublish @functionInput -Verbose

            #############################
            ##   Get missing modules   ##
            #############################
            # Add all modules that don't exist in the target location
            $missingInputObject = @{
                TemplateFilePath       = $TemplateFilePath
                VstsOrganizationUri    = '${{ parameters.vstsOrganizationUri }}'
                VstsFeedProject        = '${{ parameters.vstsFeedProject }}'
                VstsFeedName           = '${{ parameters.vstsFeedName }}'
                UseApiSpecsAlignedName = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
            }

            Write-Verbose "Invoke Get-ModulesMissingFromUniversalArtifactsFeed with" -Verbose
            Write-Verbose ($missingInputObject | ConvertTo-Json | Out-String) -Verbose

            $missingModules = Get-ModulesMissingFromUniversalArtifactsFeed @missingInputObject -BearerToken $env:TOKEN

            foreach($missingModule in $missingModules) {
              if($modulesToPublish.TemplateFilePath -notcontains $missingModule.TemplateFilePath) {
                $modulesToPublish += $missingModule
              }
            }

            # Filter modules to publish 'prerelease' only if branch is not main/master
            $BranchName = '$(Build.SourceBranch)'
            if ($BranchName -ne 'refs/heads/main' -and $BranchName -ne 'refs/heads/master') {
              Write-Verbose "Filtering modules to only publish a [prerelease] version as the current branch [$BranchName] is not [main/master]." -Verbose
              $modulesToPublish = $modulesToPublish | Where-Object -Property version -like '*-prerelease'
            }

            #################
            ##   Publish   ##
            #################
            foreach ($moduleToPublish in $modulesToPublish) {
              $RelPath = (($moduleToPublish.TemplateFilePath).Split('/modules/')[-1]).Split('/main.')[0]
              Write-Host "##[group]$(' - [{0}] [{1}]' -f $RelPath, $moduleToPublish.Version)"

              $functionInput = @{
                TemplateFilePath       = $moduleToPublish.TemplateFilePath
                VstsOrganizationUri    = '${{ parameters.vstsOrganizationUri }}'
                VstsFeedProject        = '${{ parameters.vstsFeedProject }}'
                VstsFeedName           = '${{ parameters.vstsFeedName }}'
                ModuleVersion          = $moduleToPublish.Version
                UseApiSpecsAlignedName = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
              }

              Write-Verbose "Invoke Publish-ModuleToUniversalArtifactsFeed with" -Verbose
              Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

              Publish-ModuleToUniversalArtifactsFeed @functionInput -BearerToken $env:TOKEN  -Verbose
              Write-Host "##[endgroup]"
            }
        env:
          TOKEN: $(vstsFeedToken)

      # [template-spec publish] task(s)
      #--------------------------------
      - task: AzurePowerShell@5
        displayName: 'Publish module to template specs'
        condition: and(
          eq(variables['templateSpecsDoPublish'], true),
          succeeded()
          )
        enabled: true
        inputs:
          azureSubscription: '${{ parameters.serviceConnection }}'
          azurePowerShellVersion: ${{ parameters.azurePowerShellVersion }}
          preferredAzurePowerShellVersion: ${{ parameters.preferredAzurePowerShellVersion }}
          pwsh: true
          ScriptType: InlineScript
          inline: |
            # Load PS-Profile configuration
            if (Test-Path $profile) {
                . $profile
            } else {
                Write-Warning "No profile loaded from location [$profile]"
            }

            # Set context to chosen subscription
            Write-Verbose ('Setting context to subscription [{0}]' -f '${{ parameters.subscriptionId }}') -Verbose
            $null = Set-AzContext -Subscription '${{ parameters.subscriptionId }}'

            # Load used functions
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesToPublish.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesMissingFromTemplateSpecsRG.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Publish-ModuleToTemplateSpecsRG.ps1')

            #Prioritizing the bicep file
            $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.bicep'
            if (-not (Test-Path $TemplateFilePath)) {
              $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.json'
            }

            ################################
            ##   Get modules to publish   ##
            ################################
            $functionInput = @{
              TemplateFilePath = $TemplateFilePath
              PublishLatest    = [System.Convert]::ToBoolean('${{ parameters.publishLatest }}')
            }

            Write-Verbose "Invoke Get-ModulesToPublish with" -Verbose
            Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

            $modulesToPublish = @()

            # Get the modified child resources
            $modulesToPublish += Get-ModulesToPublish @functionInput -Verbose

            #############################
            ##   Get missing modules   ##
            #############################

            # Add all modules that don't exist in the target location
            $missingInputObject = @{
                TemplateFilePath       = $TemplateFilePath
                TemplateSpecsRGName    = '${{ parameters.templateSpecsRgName }}'
                PublishLatest          = [System.Convert]::ToBoolean('${{ parameters.publishLatest }}')
                UseApiSpecsAlignedName = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
            }

            Write-Verbose "Invoke Get-ModulesMissingFromTemplateSpecsRG with" -Verbose
            Write-Verbose ($missingInputObject | ConvertTo-Json | Out-String) -Verbose

            $missingModules = Get-ModulesMissingFromTemplateSpecsRG @missingInputObject

            foreach($missingModule in $missingModules) {
              if($modulesToPublish.TemplateFilePath -notcontains $missingModule.TemplateFilePath) {
                $modulesToPublish += $missingModule
              }
            }

            # Filter modules to publish 'prerelease' only if branch is not main/master
            $BranchName = '$(Build.SourceBranch)'
            if ($BranchName -ne 'refs/heads/main' -and $BranchName -ne 'refs/heads/master') {
              Write-Verbose "Filtering modules to only publish a [prerelease] version as the current branch [$BranchName] is not [main/master]." -Verbose
              $modulesToPublish = $modulesToPublish | Where-Object -Property version -like '*-prerelease'
            }

            #################
            ##   Publish   ##
            #################
            foreach ($moduleToPublish in $modulesToPublish) {
              $RelPath = (($moduleToPublish.TemplateFilePath).Split('/modules/')[-1]).Split('/main.')[0]
              Write-Host "##[group]$(' - [{0}] [{1}]' -f $RelPath, $moduleToPublish.Version)"

              $functionInput = @{
                TemplateFilePath         = $moduleToPublish.TemplateFilePath
                TemplateSpecsRgName      = '${{ parameters.templateSpecsRgName }}'
                TemplateSpecsRgLocation  = '${{ parameters.templateSpecsRgLocation }}'
                TemplateSpecsDescription = '${{ parameters.templateSpecsDescription }}'
                ModuleVersion            = $moduleToPublish.Version
                UseApiSpecsAlignedName   = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
              }

              Write-Verbose "Invoke Publish-ModuleToTemplateSpecsRG with" -Verbose
              Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

              Publish-ModuleToTemplateSpecsRG @functionInput -Verbose
              Write-Host "##[endgroup]"
            }

      # [private bicep registry publish] task(s)
      #-------------------------------------------
      - task: AzureCLI@2
        displayName: 'Publish module to private bicep registry'
        condition: and(
          eq(variables['bicepRegistryDoPublish'], true),
          succeeded()
          )
        inputs:
          addSpnToEnvironment: true
          azureSubscription: '${{ parameters.serviceConnection }}'
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            # Load PS-Profile configuration
            if (Test-Path $profile) {
                . $profile
            } else {
                Write-Warning "No profile loaded from location [$profile]"
            }

            # Log into Az-PowerShell context
            $SecuredPassword = ConvertTo-SecureString -AsPlainText -String $env:servicePrincipalKey
            $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $env:servicePrincipalId, $SecuredPassword
            $null = Connect-AzAccount -ServicePrincipal -TenantId $env:tenantId -Credential $Credential

            # Set context to chosen subscription
            Write-Verbose ('Setting context to subscription [{0}]' -f '${{ parameters.subscriptionId }}') -Verbose
            $null = Set-AzContext -Subscription '${{ parameters.subscriptionId }}'

            # Load used functions
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesToPublish.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Get-ModulesMissingFromPrivateBicepRegistry.ps1')
            . (Join-Path '$(System.DefaultWorkingDirectory)' '$(pipelineFunctionsPath)' 'resourcePublish' 'Publish-ModuleToPrivateBicepRegistry.ps1')

            #Prioritizing the bicep file
            $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.bicep'
            if (-not (Test-Path $TemplateFilePath)) {
              $TemplateFilePath = Join-Path '$(System.DefaultWorkingDirectory)' '${{ parameters.modulePath }}' 'main.json'
            }

            ################################
            ##   Get modules to publish   ##
            ################################
            $functionInput = @{
              TemplateFilePath = $TemplateFilePath
              PublishLatest    = [System.Convert]::ToBoolean('${{ parameters.publishLatest }}')
            }

            Write-Verbose "Invoke Get-ModulesToPublish with" -Verbose
            Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

            $modulesToPublish = @()

            # Get the modified child resources
            $modulesToPublish += Get-ModulesToPublish @functionInput -Verbose

            #############################
            ##   Get missing modules   ##
            #############################
            # Add all modules that don't exist in the target location
            $missingInputObject = @{
                TemplateFilePath       = $TemplateFilePath
                BicepRegistryName      = '${{ parameters.bicepRegistryName }}'
                BicepRegistryRgName    = '${{ parameters.bicepRegistryRgName }}'
                PublishLatest          = [System.Convert]::ToBoolean('${{ parameters.publishLatest }}')
                UseApiSpecsAlignedName = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
            }

            Write-Verbose "Invoke Get-ModulesMissingFromPrivateBicepRegistry with" -Verbose
            Write-Verbose ($missingInputObject | ConvertTo-Json | Out-String) -Verbose

            $missingModules = Get-ModulesMissingFromPrivateBicepRegistry @missingInputObject

            foreach($missingModule in $missingModules) {
              if($modulesToPublish.TemplateFilePath -notcontains $missingModule.TemplateFilePath) {
                $modulesToPublish += $missingModule
              }
            }

            # Filter modules to publish 'prerelease' only if branch is not main/master
            $BranchName = '$(Build.SourceBranch)'
            if ($BranchName -ne 'refs/heads/main' -and $BranchName -ne 'refs/heads/master') {
              Write-Verbose "Filtering modules to only publish a [prerelease] version as the current branch [$BranchName] is not [main/master]." -Verbose
              $modulesToPublish = $modulesToPublish | Where-Object -Property version -like '*-prerelease'
            }

            #################
            ##   Publish   ##
            #################
            foreach ($moduleToPublish in $modulesToPublish) {
              $RelPath = (($moduleToPublish.TemplateFilePath).Split('/modules/')[-1]).Split('/main.')[0]
              Write-Host "##[group]$(' - [{0}] [{1}]' -f $RelPath, $moduleToPublish.Version)"

              $functionInput = @{
                TemplateFilePath        = $moduleToPublish.TemplateFilePath
                BicepRegistryName       = '${{ parameters.bicepRegistryName }}'
                BicepRegistryRgName     = '${{ parameters.bicepRegistryRgName }}'
                BicepRegistryRgLocation = '${{ parameters.bicepRegistryRgLocation }}'
                ModuleVersion           = $moduleToPublish.Version
                UseApiSpecsAlignedName  = [System.Convert]::ToBoolean('${{ parameters.useApiSpecsAlignedName }}')
              }

              Write-Verbose "Invoke Publish-ModuleToPrivateBicepRegistry with" -Verbose
              Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

              Publish-ModuleToPrivateBicepRegistry @functionInput -Verbose
              Write-Host "##[endgroup]"
            }
