{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the VMSS."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. Location for all resources."
      }
    },
    "encryptionAtHost": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. This property can be used by user in the request to enable or disable the Host Encryption for the virtual machine. This will enable the encryption for all the disks including Resource/Temp disk at host itself. For security reasons, it is recommended to set encryptionAtHost to True. Restrictions: Cannot be enabled if Azure Disk Encryption (guest-VM encryption using bitlocker/DM-Crypt) is enabled on your virtual machine scale sets."
      }
    },
    "securityType": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Specifies the SecurityType of the virtual machine scale set. It is set as TrustedLaunch to enable UefiSettings."
      }
    },
    "secureBootEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies whether secure boot should be enabled on the virtual machine scale set. This parameter is part of the UefiSettings. SecurityType should be set to TrustedLaunch to enable UefiSettings."
      }
    },
    "vTpmEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies whether vTPM should be enabled on the virtual machine scale set. This parameter is part of the UefiSettings.  SecurityType should be set to TrustedLaunch to enable UefiSettings."
      }
    },
    "imageReference": {
      "type": "object",
      "metadata": {
        "description": "Required. OS image reference. In case of marketplace images, it's the combination of the publisher, offer, sku, version attributes. In case of custom images it's the resource ID of the custom image."
      }
    },
    "plan": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Specifies information about the marketplace image used to create the virtual machine. This element is only used for marketplace images. Before you can use a marketplace image from an API, you must enable the image for programmatic use."
      }
    },
    "osDisk": {
      "type": "object",
      "metadata": {
        "description": "Required. Specifies the OS disk. For security reasons, it is recommended to specify DiskEncryptionSet into the osDisk object. Restrictions: DiskEncryptionSet cannot be enabled if Azure Disk Encryption (guest-VM encryption using bitlocker/DM-Crypt) is enabled on your VM Scale sets."
      }
    },
    "dataDisks": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Specifies the data disks. For security reasons, it is recommended to specify DiskEncryptionSet into the dataDisk object. Restrictions: DiskEncryptionSet cannot be enabled if Azure Disk Encryption (guest-VM encryption using bitlocker/DM-Crypt) is enabled on your VM Scale sets."
      }
    },
    "ultraSSDEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. The flag that enables or disables a capability to have one or more managed data disks with UltraSSD_LRS storage account type on the VM or VMSS. Managed disks with storage account type UltraSSD_LRS can be added to a virtual machine or virtual machine scale set only if this property is enabled."
      }
    },
    "adminUsername": {
      "type": "secureString",
      "metadata": {
        "description": "Required. Administrator username."
      }
    },
    "adminPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. When specifying a Windows Virtual Machine, this value should be passed."
      }
    },
    "customData": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Custom data associated to the VM, this value will be automatically converted into base64 to account for the expected VM format."
      }
    },
    "roleAssignments": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Array of role assignment objects that contain the 'roleDefinitionIdOrName' and 'principalId' to define RBAC role assignments on this resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
      }
    },
    "scaleSetFaultDomain": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Optional. Fault Domain count for each placement group."
      }
    },
    "proximityPlacementGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Creates an proximity placement group and adds the VMs to it."
      }
    },
    "proximityPlacementGroupType": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Ultra"
      ],
      "metadata": {
        "description": "Optional. Specifies the type of the proximity placement group."
      }
    },
    "nicConfigurations": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Required. Configures NICs and PIPs."
      }
    },
    "vmPriority": {
      "type": "string",
      "defaultValue": "Regular",
      "allowedValues": [
        "Regular",
        "Low",
        "Spot"
      ],
      "metadata": {
        "description": "Optional. Specifies the priority for the virtual machine."
      }
    },
    "enableEvictionPolicy": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies the eviction policy for the low priority virtual machine. Will result in 'Deallocate' eviction policy."
      }
    },
    "maxPriceForLowPriorityVm": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Specifies the maximum price you are willing to pay for a low priority VM/VMSS. This price is in US Dollars."
      }
    },
    "licenseType": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "Windows_Client",
        "Windows_Server",
        ""
      ],
      "metadata": {
        "description": "Optional. Specifies that the image or disk that is being used was licensed on-premises. This element is only used for images that contain the Windows Server operating system."
      }
    },
    "enableServerSideEncryption": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies if Windows VM disks should be encrypted with Server-side encryption + Customer managed Key."
      }
    },
    "extensionDomainJoinPassword": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Required if name is specified. Password of the user specified in user parameter."
      }
    },
    "extensionDomainJoinConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Domain Join] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionAntiMalwareConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Anti Malware] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionMonitoringAgentConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Monitoring Agent] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "monitoringWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource ID of the monitoring log analytics workspace."
      }
    },
    "extensionDependencyAgentConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Dependency Agent] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionNetworkWatcherAgentConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Network Watcher Agent] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionDiskEncryptionConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Disk Encryption] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionDSCConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false
      },
      "metadata": {
        "description": "Optional. The configuration for the [Desired State Configuration] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "extensionCustomScriptConfig": {
      "type": "object",
      "defaultValue": {
        "enabled": false,
        "fileData": []
      },
      "metadata": {
        "description": "Optional. The configuration for the [Custom Script] extension. Must at least contain the [\"enabled\": true] property to be executed."
      }
    },
    "bootDiagnosticStorageAccountUri": {
      "type": "string",
      "defaultValue": "[format('.blob.{0}/', environment().suffixes.storage)]",
      "metadata": {
        "description": "Optional. Storage account boot diagnostic base URI."
      }
    },
    "bootDiagnosticStorageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Storage account used to store boot diagnostic information. Boot diagnostics will be disabled if no value is provided."
      }
    },
    "diagnosticLogsRetentionInDays": {
      "type": "int",
      "defaultValue": 365,
      "maxValue": 365,
      "minValue": 0,
      "metadata": {
        "description": "Optional. Specifies the number of days that logs will be kept for; a value of 0 will retain data indefinitely."
      }
    },
    "diagnosticStorageAccountId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource ID of the diagnostic storage account."
      }
    },
    "diagnosticWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource ID of the diagnostic log analytics workspace."
      }
    },
    "diagnosticEventHubAuthorizationRuleId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
      }
    },
    "diagnosticEventHubName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category."
      }
    },
    "lock": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Specify the type of lock."
      },
      "allowedValues": [
        "",
        "CanNotDelete",
        "ReadOnly"
      ]
    },
    "upgradePolicyMode": {
      "type": "string",
      "defaultValue": "Manual",
      "allowedValues": [
        "Manual",
        "Automatic",
        "Rolling"
      ],
      "metadata": {
        "description": "Optional. Specifies the mode of an upgrade to virtual machines in the scale set.' Manual - You control the application of updates to virtual machines in the scale set. You do this by using the manualUpgrade action. ; Automatic - All virtual machines in the scale set are automatically updated at the same time. - Automatic, Manual, Rolling."
      }
    },
    "maxBatchInstancePercent": {
      "type": "int",
      "defaultValue": 20,
      "metadata": {
        "description": "Optional. The maximum percent of total virtual machine instances that will be upgraded simultaneously by the rolling upgrade in one batch. As this is a maximum, unhealthy instances in previous or future batches can cause the percentage of instances in a batch to decrease to ensure higher reliability."
      }
    },
    "maxUnhealthyInstancePercent": {
      "type": "int",
      "defaultValue": 20,
      "metadata": {
        "description": "Optional. The maximum percentage of the total virtual machine instances in the scale set that can be simultaneously unhealthy, either as a result of being upgraded, or by being found in an unhealthy state by the virtual machine health checks before the rolling upgrade aborts. This constraint will be checked prior to starting any batch."
      }
    },
    "maxUnhealthyUpgradedInstancePercent": {
      "type": "int",
      "defaultValue": 20,
      "metadata": {
        "description": "Optional. The maximum percentage of the total virtual machine instances in the scale set that can be simultaneously unhealthy, either as a result of being upgraded, or by being found in an unhealthy state by the virtual machine health checks before the rolling upgrade aborts. This constraint will be checked prior to starting any batch."
      }
    },
    "pauseTimeBetweenBatches": {
      "type": "string",
      "defaultValue": "PT0S",
      "metadata": {
        "description": "Optional. The wait time between completing the update for all virtual machines in one batch and starting the next batch. The time duration should be specified in ISO 8601 format."
      }
    },
    "enableAutomaticOSUpgrade": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Indicates whether OS upgrades should automatically be applied to scale set instances in a rolling fashion when a newer version of the OS image becomes available. Default value is false. If this is set to true for Windows based scale sets, enableAutomaticUpdates is automatically set to false and cannot be set to true."
      }
    },
    "disableAutomaticRollback": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Whether OS image rollback feature should be disabled."
      }
    },
    "automaticRepairsPolicyEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies whether automatic repairs should be enabled on the virtual machine scale set."
      }
    },
    "gracePeriod": {
      "type": "string",
      "defaultValue": "PT30M",
      "metadata": {
        "description": "Optional. The amount of time for which automatic repairs are suspended due to a state change on VM. The grace time starts after the state change has completed. This helps avoid premature or accidental repairs. The time duration should be specified in ISO 8601 format. The minimum allowed grace period is 30 minutes (PT30M). The maximum allowed grace period is 90 minutes (PT90M)."
      }
    },
    "vmNamePrefix": {
      "type": "string",
      "defaultValue": "vmssvm",
      "maxLength": 15,
      "minLength": 1,
      "metadata": {
        "description": "Optional. Specifies the computer name prefix for all of the virtual machines in the scale set."
      }
    },
    "provisionVMAgent": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Indicates whether virtual machine agent should be provisioned on the virtual machine. When this property is not specified in the request body, default behavior is to set it to true. This will ensure that VM Agent is installed on the VM so that extensions can be added to the VM later."
      }
    },
    "enableAutomaticUpdates": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Indicates whether Automatic Updates is enabled for the Windows virtual machine. Default value is true. For virtual machine scale sets, this property can be updated and updates will take effect on OS reprovisioning."
      }
    },
    "timeZone": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Specifies the time zone of the virtual machine. e.g. 'Pacific Standard Time'. Possible values can be `TimeZoneInfo.id` value from time zones returned by `TimeZoneInfo.GetSystemTimeZones`."
      }
    },
    "additionalUnattendContent": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Specifies additional base-64 encoded XML formatted information that can be included in the Unattend.xml file, which is used by Windows Setup. - AdditionalUnattendContent object."
      }
    },
    "winRM": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Specifies the Windows Remote Management listeners. This enables remote Windows PowerShell. - WinRMConfiguration object."
      }
    },
    "disablePasswordAuthentication": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies whether password authentication should be disabled."
      }
    },
    "publicKeys": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. The list of SSH public keys used to authenticate with linux based VMs."
      }
    },
    "secrets": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. Specifies set of certificates that should be installed onto the virtual machines in the scale set."
      }
    },
    "scheduledEventsProfile": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Specifies Scheduled Event related configurations."
      }
    },
    "overprovision": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Specifies whether the Virtual Machine Scale Set should be overprovisioned."
      }
    },
    "doNotRunExtensionsOnOverprovisionedVMs": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. When Overprovision is enabled, extensions are launched only on the requested number of VMs which are finally kept. This property will hence ensure that the extensions do not run on the extra overprovisioned VMs."
      }
    },
    "zoneBalance": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Whether to force strictly even Virtual Machine distribution cross x-zones in case there is zone outage."
      }
    },
    "singlePlacementGroup": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. When true this limits the scale set to a single placement group, of max size 100 virtual machines. NOTE: If singlePlacementGroup is true, it may be modified to false. However, if singlePlacementGroup is false, it may not be modified to true."
      }
    },
    "scaleInPolicy": {
      "type": "object",
      "defaultValue": {
        "rules": [
          "Default"
        ]
      },
      "metadata": {
        "description": "Optional. Specifies the scale-in policy that decides which virtual machines are chosen for removal when a Virtual Machine Scale Set is scaled-in."
      }
    },
    "skuName": {
      "type": "string",
      "metadata": {
        "description": "Required. The SKU size of the VMs."
      }
    },
    "skuCapacity": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Optional. The initial instance count of scale set VMs."
      }
    },
    "availabilityZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional. The virtual machine scale set zones. NOTE: Availability zones can only be set when you create the scale set."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. Tags of the resource."
      }
    },
    "enableDefaultTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
      }
    },
    "osType": {
      "type": "string",
      "allowedValues": [
        "Windows",
        "Linux"
      ],
      "metadata": {
        "description": "Required. The chosen OS type."
      }
    },
    "baseTime": {
      "type": "string",
      "defaultValue": "[utcNow('u')]",
      "metadata": {
        "description": "Generated. Do not provide a value! This date value is used to generate a registration token."
      }
    },
    "sasTokenValidityLength": {
      "type": "string",
      "defaultValue": "PT8H",
      "metadata": {
        "description": "Optional. SAS token validity length to use to download files from storage accounts. Usage: 'PT8H' - valid for 8 hours; 'P5D' - valid for 5 days; 'P1Y' - valid for 1 year. When not provided, the SAS token will be valid for 8 hours."
      }
    },
    "systemAssignedIdentity": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Enables system assigned managed identity on the resource."
      }
    },
    "userAssignedIdentities": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional. The ID(s) to assign to the resource."
      }
    },
    "diagnosticMetricsToEnable": {
      "type": "array",
      "defaultValue": [
        "AllMetrics"
      ],
      "allowedValues": [
        "AllMetrics"
      ],
      "metadata": {
        "description": "Optional. The name of metrics that will be streamed."
      }
    },
    "publicIpDiagnosticSettingsName": {
      "type": "string",
      "defaultValue": "[format('{0}-diagnosticSettings', parameters('name'))]",
      "metadata": {
        "description": "Optional. The name of the diagnostic setting, if deployed."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "diagnosticsMetrics",
        "count": "[length(parameters('diagnosticMetricsToEnable'))]",
        "input": {
          "category": "[parameters('diagnosticMetricsToEnable')[copyIndex('diagnosticsMetrics')]]",
          "timeGrain": null,
          "enabled": true,
          "retentionPolicy": {
            "enabled": true,
            "days": "[parameters('diagnosticLogsRetentionInDays')]"
          }
        }
      },
      {
        "name": "publicKeysFormatted",
        "count": "[length(parameters('publicKeys'))]",
        "input": {
          "path": "[parameters('publicKeys')[copyIndex('publicKeysFormatted')].path]",
          "keyData": "[parameters('publicKeys')[copyIndex('publicKeysFormatted')].keyData]"
        }
      }
    ],
    "linuxConfiguration": {
      "disablePasswordAuthentication": "[parameters('disablePasswordAuthentication')]",
      "ssh": {
        "publicKeys": "[variables('publicKeysFormatted')]"
      },
      "provisionVMAgent": "[parameters('provisionVMAgent')]"
    },
    "windowsConfiguration": {
      "provisionVMAgent": "[parameters('provisionVMAgent')]",
      "enableAutomaticUpdates": "[parameters('enableAutomaticUpdates')]",
      "timeZone": "[if(empty(parameters('timeZone')), null(), parameters('timeZone'))]",
      "additionalUnattendContent": "[if(empty(parameters('additionalUnattendContent')), null(), parameters('additionalUnattendContent'))]",
      "winRM": "[if(not(empty(parameters('winRM'))), createObject('listeners', parameters('winRM')), null())]"
    },
    "accountSasProperties": {
      "signedServices": "b",
      "signedPermission": "r",
      "signedExpiry": "[dateTimeAdd(parameters('baseTime'), parameters('sasTokenValidityLength'))]",
      "signedResourceTypes": "o",
      "signedProtocol": "https"
    },
    "identityType": "[if(parameters('systemAssignedIdentity'), if(not(empty(parameters('userAssignedIdentities'))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(parameters('userAssignedIdentities'))), 'UserAssigned', 'None'))]",
    "identity": "[if(not(equals(variables('identityType'), 'None')), createObject('type', variables('identityType'), 'userAssignedIdentities', if(not(empty(parameters('userAssignedIdentities'))), parameters('userAssignedIdentities'), null())), null())]",
    "enableReferencedModulesTelemetry": false
  },
  "resources": [
    {
      "condition": "[parameters('enableDefaultTelemetry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "condition": "[not(empty(parameters('proximityPlacementGroupName')))]",
      "type": "Microsoft.Compute/proximityPlacementGroups",
      "apiVersion": "2021-04-01",
      "name": "[if(not(empty(parameters('proximityPlacementGroupName'))), parameters('proximityPlacementGroupName'), 'dummyProximityGroup')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "proximityPlacementGroupType": "[parameters('proximityPlacementGroupType')]"
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2021-04-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "identity": "[variables('identity')]",
      "zones": "[parameters('availabilityZones')]",
      "properties": {
        "proximityPlacementGroup": "[if(not(empty(parameters('proximityPlacementGroupName'))), createObject('id', resourceId('Microsoft.Compute/proximityPlacementGroups', if(not(empty(parameters('proximityPlacementGroupName'))), parameters('proximityPlacementGroupName'), 'dummyProximityGroup'))), null())]",
        "upgradePolicy": {
          "mode": "[parameters('upgradePolicyMode')]",
          "rollingUpgradePolicy": {
            "maxBatchInstancePercent": "[parameters('maxBatchInstancePercent')]",
            "maxUnhealthyInstancePercent": "[parameters('maxUnhealthyInstancePercent')]",
            "maxUnhealthyUpgradedInstancePercent": "[parameters('maxUnhealthyUpgradedInstancePercent')]",
            "pauseTimeBetweenBatches": "[parameters('pauseTimeBetweenBatches')]"
          },
          "automaticOSUpgradePolicy": {
            "enableAutomaticOSUpgrade": "[parameters('enableAutomaticOSUpgrade')]",
            "disableAutomaticRollback": "[parameters('disableAutomaticRollback')]"
          }
        },
        "automaticRepairsPolicy": {
          "enabled": "[parameters('automaticRepairsPolicyEnabled')]",
          "gracePeriod": "[parameters('gracePeriod')]"
        },
        "virtualMachineProfile": {
          "osProfile": {
            "computerNamePrefix": "[parameters('vmNamePrefix')]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[if(not(empty(parameters('adminPassword'))), parameters('adminPassword'), null())]",
            "customData": "[if(not(empty(parameters('customData'))), base64(parameters('customData')), null())]",
            "windowsConfiguration": "[if(equals(parameters('osType'), 'Windows'), variables('windowsConfiguration'), null())]",
            "linuxConfiguration": "[if(equals(parameters('osType'), 'Linux'), variables('linuxConfiguration'), null())]",
            "secrets": "[parameters('secrets')]"
          },
          "securityProfile": {
            "encryptionAtHost": "[if(parameters('encryptionAtHost'), parameters('encryptionAtHost'), null())]",
            "securityType": "[parameters('securityType')]",
            "uefiSettings": "[if(equals(parameters('securityType'), 'TrustedLaunch'), createObject('secureBootEnabled', parameters('secureBootEnabled'), 'vTpmEnabled', parameters('vTpmEnabled')), null())]"
          },
          "storageProfile": {
            "copy": [
              {
                "name": "dataDisks",
                "count": "[length(parameters('dataDisks'))]",
                "input": {
                  "lun": "[copyIndex('dataDisks')]",
                  "diskSizeGB": "[parameters('dataDisks')[copyIndex('dataDisks')].diskSizeGB]",
                  "createOption": "[parameters('dataDisks')[copyIndex('dataDisks')].createOption]",
                  "caching": "[parameters('dataDisks')[copyIndex('dataDisks')].caching]",
                  "writeAcceleratorEnabled": "[if(contains(parameters('osDisk'), 'writeAcceleratorEnabled'), parameters('osDisk').writeAcceleratorEnabled, null())]",
                  "managedDisk": {
                    "storageAccountType": "[parameters('dataDisks')[copyIndex('dataDisks')].managedDisk.storageAccountType]",
                    "diskEncryptionSet": {
                      "id": "[if(parameters('enableServerSideEncryption'), parameters('dataDisks')[copyIndex('dataDisks')].managedDisk.diskEncryptionSet.id, null())]"
                    }
                  },
                  "diskIOPSReadWrite": "[if(contains(parameters('osDisk'), 'diskIOPSReadWrite'), parameters('dataDisks')[copyIndex('dataDisks')].diskIOPSReadWrite, null())]",
                  "diskMBpsReadWrite": "[if(contains(parameters('osDisk'), 'diskMBpsReadWrite'), parameters('dataDisks')[copyIndex('dataDisks')].diskMBpsReadWrite, null())]"
                }
              }
            ],
            "imageReference": "[parameters('imageReference')]",
            "osDisk": {
              "createOption": "[parameters('osDisk').createOption]",
              "diskSizeGB": "[parameters('osDisk').diskSizeGB]",
              "caching": "[if(contains(parameters('osDisk'), 'caching'), parameters('osDisk').caching, null())]",
              "writeAcceleratorEnabled": "[if(contains(parameters('osDisk'), 'writeAcceleratorEnabled'), parameters('osDisk').writeAcceleratorEnabled, null())]",
              "diffDiskSettings": "[if(contains(parameters('osDisk'), 'diffDiskSettings'), parameters('osDisk').diffDiskSettings, null())]",
              "osType": "[if(contains(parameters('osDisk'), 'osType'), parameters('osDisk').osType, null())]",
              "image": "[if(contains(parameters('osDisk'), 'image'), parameters('osDisk').image, null())]",
              "vhdContainers": "[if(contains(parameters('osDisk'), 'vhdContainers'), parameters('osDisk').vhdContainers, null())]",
              "managedDisk": {
                "storageAccountType": "[parameters('osDisk').managedDisk.storageAccountType]",
                "diskEncryptionSet": "[if(contains(parameters('osDisk').managedDisk, 'diskEncryptionSet'), parameters('osDisk').managedDisk.diskEncryptionSet, null())]"
              }
            }
          },
          "networkProfile": {
            "copy": [
              {
                "name": "networkInterfaceConfigurations",
                "count": "[length(parameters('nicConfigurations'))]",
                "input": {
                  "name": "[format('{0}{1}configuration-{2}', parameters('name'), parameters('nicConfigurations')[copyIndex('networkInterfaceConfigurations')].nicSuffix, copyIndex('networkInterfaceConfigurations'))]",
                  "properties": {
                    "primary": "[if(equals(copyIndex('networkInterfaceConfigurations'), 0), true(), null())]",
                    "enableAcceleratedNetworking": "[if(contains(parameters('nicConfigurations'), 'enableAcceleratedNetworking'), parameters('nicConfigurations')[copyIndex('networkInterfaceConfigurations')].enableAcceleratedNetworking, null())]",
                    "networkSecurityGroup": "[if(contains(parameters('nicConfigurations'), 'nsgId'), createObject('id', parameters('nicConfigurations')[copyIndex('networkInterfaceConfigurations')].nsgId), null())]",
                    "ipConfigurations": "[parameters('nicConfigurations')[copyIndex('networkInterfaceConfigurations')].ipConfigurations]"
                  }
                }
              }
            ]
          },
          "diagnosticsProfile": {
            "bootDiagnostics": {
              "enabled": "[not(empty(parameters('bootDiagnosticStorageAccountName')))]",
              "storageUri": "[if(not(empty(parameters('bootDiagnosticStorageAccountName'))), format('https://{0}{1}', parameters('bootDiagnosticStorageAccountName'), parameters('bootDiagnosticStorageAccountUri')), null())]"
            }
          },
          "licenseType": "[if(empty(parameters('licenseType')), null(), parameters('licenseType'))]",
          "priority": "[parameters('vmPriority')]",
          "evictionPolicy": "[if(parameters('enableEvictionPolicy'), 'Deallocate', null())]",
          "billingProfile": "[if(and(not(empty(parameters('vmPriority'))), not(empty(parameters('maxPriceForLowPriorityVm')))), json(format('{{\"maxPrice\":\"{0}\"}}', parameters('maxPriceForLowPriorityVm'))), null())]",
          "scheduledEventsProfile": "[parameters('scheduledEventsProfile')]"
        },
        "overprovision": "[parameters('overprovision')]",
        "doNotRunExtensionsOnOverprovisionedVMs": "[parameters('doNotRunExtensionsOnOverprovisionedVMs')]",
        "zoneBalance": "[if(equals(parameters('zoneBalance'), 'true'), parameters('zoneBalance'), null())]",
        "platformFaultDomainCount": "[parameters('scaleSetFaultDomain')]",
        "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
        "additionalCapabilities": {
          "ultraSSDEnabled": "[parameters('ultraSSDEnabled')]"
        },
        "scaleInPolicy": "[parameters('scaleInPolicy')]"
      },
      "sku": {
        "name": "[parameters('skuName')]",
        "capacity": "[parameters('skuCapacity')]"
      },
      "plan": "[if(not(empty(parameters('plan'))), parameters('plan'), null())]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/proximityPlacementGroups', if(not(empty(parameters('proximityPlacementGroupName'))), parameters('proximityPlacementGroupName'), 'dummyProximityGroup'))]"
      ]
    },
    {
      "condition": "[not(empty(parameters('lock')))]",
      "type": "Microsoft.Authorization/locks",
      "apiVersion": "2017-04-01",
      "scope": "[format('Microsoft.Compute/virtualMachineScaleSets/{0}', parameters('name'))]",
      "name": "[format('{0}-{1}-lock', parameters('name'), parameters('lock'))]",
      "properties": {
        "level": "[parameters('lock')]",
        "notes": "[if(equals(parameters('lock'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot modify the resource or child resources.')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[or(or(or(not(empty(parameters('diagnosticStorageAccountId'))), not(empty(parameters('diagnosticWorkspaceId')))), not(empty(parameters('diagnosticEventHubAuthorizationRuleId')))), not(empty(parameters('diagnosticEventHubName'))))]",
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Compute/virtualMachineScaleSets/{0}', parameters('name'))]",
      "name": "[parameters('publicIpDiagnosticSettingsName')]",
      "properties": {
        "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
        "workspaceId": "[if(not(empty(parameters('diagnosticWorkspaceId'))), parameters('diagnosticWorkspaceId'), null())]",
        "eventHubAuthorizationRuleId": "[if(not(empty(parameters('diagnosticEventHubAuthorizationRuleId'))), parameters('diagnosticEventHubAuthorizationRuleId'), null())]",
        "eventHubName": "[if(not(empty(parameters('diagnosticEventHubName'))), parameters('diagnosticEventHubName'), null())]",
        "metrics": "[variables('diagnosticsMetrics')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionDomainJoinConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-DomainJoin', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "DomainJoin"
          },
          "publisher": {
            "value": "Microsoft.Compute"
          },
          "type": {
            "value": "JsonADDomainExtension"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionDomainJoinConfig'), 'typeHandlerVersion'), parameters('extensionDomainJoinConfig').typeHandlerVersion, '1.3')]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionDomainJoinConfig'), 'autoUpgradeMinorVersion'), parameters('extensionDomainJoinConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionDomainJoinConfig'), 'enableAutomaticUpgrade'), parameters('extensionDomainJoinConfig').enableAutomaticUpgrade, false())]"
          },
          "settings": {
            "value": "[parameters('extensionDomainJoinConfig').settings]"
          },
          "protectedSettings": {
            "value": {
              "Password": "[parameters('extensionDomainJoinPassword')]"
            }
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionAntiMalwareConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-MicrosoftAntiMalware', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "MicrosoftAntiMalware"
          },
          "publisher": {
            "value": "Microsoft.Azure.Security"
          },
          "type": {
            "value": "IaaSAntimalware"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionAntiMalwareConfig'), 'typeHandlerVersion'), parameters('extensionAntiMalwareConfig').typeHandlerVersion, '1.3')]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionAntiMalwareConfig'), 'autoUpgradeMinorVersion'), parameters('extensionAntiMalwareConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionAntiMalwareConfig'), 'enableAutomaticUpgrade'), parameters('extensionAntiMalwareConfig').enableAutomaticUpgrade, false())]"
          },
          "settings": {
            "value": "[parameters('extensionAntiMalwareConfig').settings]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionMonitoringAgentConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-MicrosoftMonitoringAgent', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "MicrosoftMonitoringAgent"
          },
          "publisher": {
            "value": "Microsoft.EnterpriseCloud.Monitoring"
          },
          "type": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'MicrosoftMonitoringAgent', 'OmsAgentForLinux')]"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionMonitoringAgentConfig'), 'typeHandlerVersion'), parameters('extensionMonitoringAgentConfig').typeHandlerVersion, if(equals(parameters('osType'), 'Windows'), '1.0', '1.7'))]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionMonitoringAgentConfig'), 'autoUpgradeMinorVersion'), parameters('extensionMonitoringAgentConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionMonitoringAgentConfig'), 'enableAutomaticUpgrade'), parameters('extensionMonitoringAgentConfig').enableAutomaticUpgrade, false())]"
          },
          "settings": {
            "value": {
              "workspaceId": "[if(not(empty(parameters('monitoringWorkspaceId'))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('monitoringWorkspaceId'), '/')[2], split(parameters('monitoringWorkspaceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', last(split(parameters('monitoringWorkspaceId'), '/'))), '2021-06-01').customerId, '')]"
            }
          },
          "protectedSettings": {
            "value": {
              "workspaceKey": "[if(not(empty(parameters('monitoringWorkspaceId'))), listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('monitoringWorkspaceId'), '/')[2], split(parameters('monitoringWorkspaceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', last(split(parameters('monitoringWorkspaceId'), '/'))), '2021-06-01').primarySharedKey, '')]"
            }
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionDependencyAgentConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-DependencyAgent', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "DependencyAgent"
          },
          "publisher": {
            "value": "Microsoft.Azure.Monitoring.DependencyAgent"
          },
          "type": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'DependencyAgentWindows', 'DependencyAgentLinux')]"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionDependencyAgentConfig'), 'typeHandlerVersion'), parameters('extensionDependencyAgentConfig').typeHandlerVersion, '9.5')]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionDependencyAgentConfig'), 'autoUpgradeMinorVersion'), parameters('extensionDependencyAgentConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionDependencyAgentConfig'), 'enableAutomaticUpgrade'), parameters('extensionDependencyAgentConfig').enableAutomaticUpgrade, true())]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionNetworkWatcherAgentConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-NetworkWatcherAgent', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "NetworkWatcherAgent"
          },
          "publisher": {
            "value": "Microsoft.Azure.NetworkWatcher"
          },
          "type": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'NetworkWatcherAgentWindows', 'NetworkWatcherAgentLinux')]"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionNetworkWatcherAgentConfig'), 'typeHandlerVersion'), parameters('extensionNetworkWatcherAgentConfig').typeHandlerVersion, '1.4')]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionNetworkWatcherAgentConfig'), 'autoUpgradeMinorVersion'), parameters('extensionNetworkWatcherAgentConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionNetworkWatcherAgentConfig'), 'enableAutomaticUpgrade'), parameters('extensionNetworkWatcherAgentConfig').enableAutomaticUpgrade, false())]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionDSCConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-DesiredStateConfiguration', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "DesiredStateConfiguration"
          },
          "publisher": {
            "value": "Microsoft.Powershell"
          },
          "type": {
            "value": "DSC"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionDSCConfig'), 'typeHandlerVersion'), parameters('extensionDSCConfig').typeHandlerVersion, '2.77')]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionDSCConfig'), 'autoUpgradeMinorVersion'), parameters('extensionDSCConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionDSCConfig'), 'enableAutomaticUpgrade'), parameters('extensionDSCConfig').enableAutomaticUpgrade, false())]"
          },
          "settings": {
            "value": "[if(contains(parameters('extensionDSCConfig'), 'settings'), parameters('extensionDSCConfig').settings, createObject())]"
          },
          "protectedSettings": {
            "value": "[if(contains(parameters('extensionDSCConfig'), 'protectedSettings'), parameters('extensionDSCConfig').protectedSettings, createObject())]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    },
    {
      "condition": "[parameters('extensionCustomScriptConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-CustomScriptExtension', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "CustomScriptExtension"
          },
          "publisher": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'Microsoft.Compute', 'Microsoft.Azure.Extensions')]"
          },
          "type": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'CustomScriptExtension', 'CustomScript')]"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionCustomScriptConfig'), 'typeHandlerVersion'), parameters('extensionCustomScriptConfig').typeHandlerVersion, if(equals(parameters('osType'), 'Windows'), '1.10', '2.1'))]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionCustomScriptConfig'), 'autoUpgradeMinorVersion'), parameters('extensionCustomScriptConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionCustomScriptConfig'), 'enableAutomaticUpgrade'), parameters('extensionCustomScriptConfig').enableAutomaticUpgrade, false())]"
          },
          "settings": {
            "value": {
              "copy": [
                {
                  "name": "fileUris",
                  "count": "[length(parameters('extensionCustomScriptConfig').fileData)]",
                  "input": "[if(contains(parameters('extensionCustomScriptConfig').fileData[copyIndex('fileUris')], 'storageAccountId'), format('{0}?{1}', parameters('extensionCustomScriptConfig').fileData[copyIndex('fileUris')].uri, listAccountSas(parameters('extensionCustomScriptConfig').fileData[copyIndex('fileUris')].storageAccountId, '2019-04-01', variables('accountSasProperties')).accountSasToken), parameters('extensionCustomScriptConfig').fileData[copyIndex('fileUris')].uri)]"
                }
              ]
            }
          },
          "protectedSettings": {
            "value": "[if(contains(parameters('extensionCustomScriptConfig'), 'protectedSettings'), parameters('extensionCustomScriptConfig').protectedSettings, createObject())]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-VMSS-DesiredStateConfiguration', uniqueString(deployment().name, parameters('location'))))]"
      ]
    },
    {
      "condition": "[parameters('extensionDiskEncryptionConfig').enabled]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-DiskEncryption', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualMachineScaleSetName": {
            "value": "[parameters('name')]"
          },
          "name": {
            "value": "DiskEncryption"
          },
          "publisher": {
            "value": "Microsoft.Azure.Security"
          },
          "type": {
            "value": "[if(equals(parameters('osType'), 'Windows'), 'AzureDiskEncryption', 'AzureDiskEncryptionForLinux')]"
          },
          "typeHandlerVersion": {
            "value": "[if(contains(parameters('extensionDiskEncryptionConfig'), 'typeHandlerVersion'), parameters('extensionDiskEncryptionConfig').typeHandlerVersion, if(equals(parameters('osType'), 'Windows'), '2.2', '1.1'))]"
          },
          "autoUpgradeMinorVersion": {
            "value": "[if(contains(parameters('extensionDiskEncryptionConfig'), 'autoUpgradeMinorVersion'), parameters('extensionDiskEncryptionConfig').autoUpgradeMinorVersion, true())]"
          },
          "enableAutomaticUpgrade": {
            "value": "[if(contains(parameters('extensionDiskEncryptionConfig'), 'enableAutomaticUpgrade'), parameters('extensionDiskEncryptionConfig').enableAutomaticUpgrade, false())]"
          },
          "forceUpdateTag": {
            "value": "[if(contains(parameters('extensionDiskEncryptionConfig'), 'forceUpdateTag'), parameters('extensionDiskEncryptionConfig').forceUpdateTag, '1.0')]"
          },
          "settings": {
            "value": "[parameters('extensionDiskEncryptionConfig').settings]"
          },
          "enableDefaultTelemetry": {
            "value": "[variables('enableReferencedModulesTelemetry')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "virtualMachineScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "Conditional. The name of the parent virtual machine scale set that extension is provisioned for. Required if the template is used in a standalone deployment."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the virtual machine scale set extension."
              }
            },
            "publisher": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the extension handler publisher."
              }
            },
            "type": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the type of the extension; an example is \"CustomScriptExtension\"."
              }
            },
            "typeHandlerVersion": {
              "type": "string",
              "metadata": {
                "description": "Required. Specifies the version of the script handler."
              }
            },
            "autoUpgradeMinorVersion": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should use a newer minor version if one is available at deployment time. Once deployed, however, the extension will not upgrade minor versions unless redeployed, even with this property set to true."
              }
            },
            "forceUpdateTag": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. How the extension handler should be forced to update even if the extension configuration has not changed."
              }
            },
            "settings": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific settings."
              }
            },
            "protectedSettings": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "Optional. Any object that contains the extension specific protected settings."
              }
            },
            "supressFailures": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Indicates whether failures stemming from the extension will be suppressed (Operational failures such as not connecting to the VM will not be suppressed regardless of this value). The default is false."
              }
            },
            "enableAutomaticUpgrade": {
              "type": "bool",
              "metadata": {
                "description": "Required. Indicates whether the extension should be automatically upgraded by the platform if there is a newer version of the extension available."
              }
            },
            "enableDefaultTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry via the Customer Usage Attribution ID (GUID)."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('enableDefaultTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2021-04-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2021-07-01",
              "name": "[format('{0}/{1}', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "properties": {
                "publisher": "[parameters('publisher')]",
                "type": "[parameters('type')]",
                "typeHandlerVersion": "[parameters('typeHandlerVersion')]",
                "autoUpgradeMinorVersion": "[parameters('autoUpgradeMinorVersion')]",
                "enableAutomaticUpgrade": "[parameters('enableAutomaticUpgrade')]",
                "forceUpdateTag": "[if(not(empty(parameters('forceUpdateTag'))), parameters('forceUpdateTag'), null())]",
                "settings": "[if(not(empty(parameters('settings'))), parameters('settings'), null())]",
                "protectedSettings": "[if(not(empty(parameters('protectedSettings'))), parameters('protectedSettings'), null())]",
                "suppressFailures": "[parameters('supressFailures')]"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]",
              "metadata": {
                "description": "The name of the extension."
              }
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('virtualMachineScaleSetName'), parameters('name'))]",
              "metadata": {
                "description": "The ResourceId of the extension."
              }
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[resourceGroup().name]",
              "metadata": {
                "description": "The name of the Resource Group the extension was created in."
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-VMSS-CustomScriptExtension', uniqueString(deployment().name, parameters('location'))))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-VMSS-MicrosoftMonitoringAgent', uniqueString(deployment().name, parameters('location'))))]"
      ]
    },
    {
      "copy": {
        "name": "vmss_roleAssignments",
        "count": "[length(parameters('roleAssignments'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VMSS-Rbac-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "description": {
            "value": "[if(contains(parameters('roleAssignments')[copyIndex()], 'description'), parameters('roleAssignments')[copyIndex()].description, '')]"
          },
          "principalIds": {
            "value": "[parameters('roleAssignments')[copyIndex()].principalIds]"
          },
          "principalType": {
            "value": "[if(contains(parameters('roleAssignments')[copyIndex()], 'principalType'), parameters('roleAssignments')[copyIndex()].principalType, '')]"
          },
          "roleDefinitionIdOrName": {
            "value": "[parameters('roleAssignments')[copyIndex()].roleDefinitionIdOrName]"
          },
          "resourceId": {
            "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "principalIds": {
              "type": "array",
              "metadata": {
                "description": "Required. The IDs of the principals to assign the role to."
              }
            },
            "roleDefinitionIdOrName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the role to assign. If it cannot be found you can specify the role definition ID instead."
              }
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Required. The resource ID of the resource to apply the role assignment to."
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "",
              "allowedValues": [
                "ServicePrincipal",
                "Group",
                "User",
                "ForeignGroup",
                "Device",
                ""
              ],
              "metadata": {
                "description": "Optional. The principal type of the assigned principal ID."
              }
            },
            "description": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional. The description of the role assignment."
              }
            }
          },
          "variables": {
            "builtInRoleNames": {
              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
              "Avere Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4f8fab4f-1852-4a58-a46a-8eaf358af14a')]",
              "Avere Operator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c025889f-8102-4ebf-b32c-fc0c6f0c6bd9')]",
              "DevTest Labs User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '76283e04-6283-4c54-8f91-bcf1374a3c64')]",
              "Log Analytics Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]",
              "Log Analytics Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '73c42c96-874c-492b-b04d-ab87d138a893')]",
              "Managed Application Contributor Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '641177b8-a67a-45b9-a033-47bc880bb21e')]",
              "Managed Application Operator Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c7393b34-138c-406f-901b-d8cf2b17e6ae')]",
              "Managed Applications Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b9331d33-8a36-4f8c-b097-4f54124fdb44')]",
              "Monitoring Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '749f88d5-cbae-40b8-bcfc-e573ddc772fa')]",
              "Monitoring Metrics Publisher": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]",
              "Monitoring Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
              "Reservation Purchaser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f7b75c60-3036-4b75-91c3-6b41c27c1689')]",
              "Resource Policy Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '36243c78-bf99-498c-9df9-86d9f8d28608')]",
              "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]",
              "Virtual Machine Administrator Login": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1c0163c0-47e6-4577-8991-ea5c82e286e4')]",
              "Virtual Machine Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
              "Virtual Machine User Login": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'fb879df8-f326-4884-b1cf-06f3ad86be52')]"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "roleAssignment",
                "count": "[length(parameters('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-10-01-preview",
              "scope": "[format('Microsoft.Compute/virtualMachineScaleSets/{0}', last(split(parameters('resourceId'), '/')))]",
              "name": "[guid(resourceId('Microsoft.Compute/virtualMachineScaleSets', last(split(parameters('resourceId'), '/'))), parameters('principalIds')[copyIndex()], parameters('roleDefinitionIdOrName'))]",
              "properties": {
                "description": "[parameters('description')]",
                "roleDefinitionId": "[if(contains(variables('builtInRoleNames'), parameters('roleDefinitionIdOrName')), variables('builtInRoleNames')[parameters('roleDefinitionIdOrName')], parameters('roleDefinitionIdOrName'))]",
                "principalId": "[parameters('principalIds')[copyIndex()]]",
                "principalType": "[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]"
      ]
    }
  ],
  "outputs": {
    "resourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name'))]",
      "metadata": {
        "description": "The resource ID of the virtual machine scale set."
      }
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]",
      "metadata": {
        "description": "The resource group of the virtual machine scale set."
      }
    },
    "name": {
      "type": "string",
      "value": "[parameters('name')]",
      "metadata": {
        "description": "The name of the virtual machine scale set."
      }
    },
    "systemAssignedPrincipalId": {
      "type": "string",
      "value": "[if(and(parameters('systemAssignedIdentity'), contains(reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name')), '2021-04-01', 'full').identity, 'principalId')), reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name')), '2021-04-01', 'full').identity.principalId, '')]",
      "metadata": {
        "description": "The principal ID of the system assigned identity."
      }
    },
    "location": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('name')), '2021-04-01', 'full').location]",
      "metadata": {
        "description": "The location the resource was deployed into."
      }
    }
  }
}
